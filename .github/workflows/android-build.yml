name: Android Build & Publish APK

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
      - develop
  workflow_dispatch:  # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ð¸Ð· GitHub UI

jobs:
  build:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: 34.0.0
          targets: android-34

      - name: Configure Gradle properties
        run: |
          # Ð£Ð±ÐµÐ¶Ð´Ð°ÐµÐ¼ÑÑ, Ñ‡Ñ‚Ð¾ gradle.properties ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð²ÑÐµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
          if ! grep -q "android.useAndroidX=true" gradle.properties 2>/dev/null; then
            echo "" >> gradle.properties
            echo "# AndroidX migration" >> gradle.properties
            echo "android.useAndroidX=true" >> gradle.properties
            echo "android.enableJetifier=true" >> gradle.properties
          fi
          
          # Ð£Ð±ÐµÐ¶Ð´Ð°ÐµÐ¼ÑÑ, Ñ‡Ñ‚Ð¾ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¿Ð°Ð¼ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹ (Ð²Ð°Ð¶Ð½Ð¾ Ð´Ð»Ñ CI)
          if ! grep -q "org.gradle.jvmargs" gradle.properties 2>/dev/null; then
            echo "" >> gradle.properties
            echo "# Memory settings for Gradle" >> gradle.properties
            echo "org.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1024m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8 -XX:+UseG1GC" >> gradle.properties
          fi
          
          if ! grep -q "org.gradle.parallel=true" gradle.properties 2>/dev/null; then
            echo "org.gradle.parallel=true" >> gradle.properties
            echo "org.gradle.caching=true" >> gradle.properties
            echo "org.gradle.configureondemand=true" >> gradle.properties
          fi
          
          echo "=== gradle.properties content ==="
          cat gradle.properties
          echo "=================================="

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Build APK (assembleDebug)
        env:
          # Ð¯Ð²Ð½Ð¾ Ð·Ð°Ð´Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð»Ñ AndroidX Ñ‡ÐµÑ€ÐµÐ· Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Gradle
          ORG_GRADLE_PROJECT_android_useAndroidX: "true"
          ORG_GRADLE_PROJECT_android_enableJetifier: "true"
        run: |
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²
          echo "=== Checking required resources ==="
          if [ ! -f "android/app/src/main/res/xml/backup_rules.xml" ]; then
            echo "ERROR: backup_rules.xml not found!"
            exit 1
          fi
          if [ ! -f "android/app/src/main/res/xml/data_extraction_rules.xml" ]; then
            echo "ERROR: data_extraction_rules.xml not found!"
            exit 1
          fi
          echo "All required resources found"
          echo "==================================="
          
          # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð²ÑÐµ Gradle daemon Ð¿ÐµÑ€ÐµÐ´ ÑÐ±Ð¾Ñ€ÐºÐ¾Ð¹ (Ð¾ÑÐ²Ð¾Ð±Ð¾Ð¶Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¼ÑÑ‚ÑŒ)
          ./gradlew --stop || true
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐ±Ð¾Ñ€ÐºÑƒ Ñ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ð¼Ð¸
          # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ --no-daemon Ð´Ð»Ñ CI, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð±ÐµÐ¶Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼ Ñ Ð¿Ð°Ð¼ÑÑ‚ÑŒÑŽ
          # --max-workers Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡Ð¸Ð²Ð°ÐµÑ‚ Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»Ð¸Ð·Ð¼ Ð¸ ÑÐ½Ð¸Ð¶Ð°ÐµÑ‚ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð°Ð¼ÑÑ‚Ð¸
          ./gradlew assembleDebug \
            -Pandroid.useAndroidX=true \
            -Pandroid.enableJetifier=true \
            --no-daemon \
            --max-workers=2 \
            --stacktrace \
            --warn

      - name: Find APK files
        id: find_apk
        run: |
          APK_PATH=$(find . -name "*.apk" -path "*/build/outputs/apk/debug/*" | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "APK not found in standard location, searching..."
            APK_PATH=$(find . -name "*.apk" | head -n 1)
          fi
          
          if [ -z "$APK_PATH" ]; then
            echo "ERROR: APK file not found!"
            exit 1
          fi
          
          echo "APK found at: $APK_PATH"
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          
          # Get APK filename
          APK_NAME=$(basename "$APK_PATH")
          echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT

      - name: Create APK archive (ZIP)
        id: create_zip
        run: |
          APK_DIR=$(dirname "${{ steps.find_apk.outputs.apk_path }}")
          ZIP_PATH="$GITHUB_WORKSPACE/app-debug.zip"
          cd "$APK_DIR"
          zip -r "$ZIP_PATH" "${{ steps.find_apk.outputs.apk_name }}"
          echo "APK archived as $ZIP_PATH"
          echo "zip_path=$ZIP_PATH" >> $GITHUB_OUTPUT

      - name: Upload APK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-debug-apk
          path: |
            ${{ steps.find_apk.outputs.apk_path }}
            ${{ steps.create_zip.outputs.zip_path }}
          retention-days: 90

      - name: Build Summary
        run: |
          echo "## ðŸ“¦ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Build Status:** Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“± **APK Location:** \`${{ steps.find_apk.outputs.apk_path }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ **Download:** APK and ZIP Ð°Ñ€Ñ…Ð¸Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹ Ð² Ñ€Ð°Ð·Ð´ÐµÐ»Ðµ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸ Ð¿Ð¾ ÑÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸ÑŽ:" >> $GITHUB_STEP_SUMMARY
          echo "1. ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð² Ñ€Ð°Ð·Ð´ÐµÐ» **Summary** Ð´Ð°Ð½Ð½Ð¾Ð³Ð¾ workflow run" >> $GITHUB_STEP_SUMMARY
          echo "2. ÐŸÑ€Ð¾ÐºÑ€ÑƒÑ‚Ð¸Ñ‚Ðµ Ð²Ð½Ð¸Ð· Ð´Ð¾ ÑÐµÐºÑ†Ð¸Ð¸ **Artifacts**" >> $GITHUB_STEP_SUMMARY
          echo "3. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Ð½Ð° **android-debug-apk** Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ð°Ñ€Ñ…Ð¸Ð²" >> $GITHUB_STEP_SUMMARY
