name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-review:
    name: AI Code Review
    runs-on: ubuntu-latest
    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º draft PR
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: false
      
      - name: Restore RAG Index Cache
        uses: actions/cache@v4
        with:
          path: document_index.db
          key: rag-index-${{ hashFiles('docs/**/*.md', 'README.md') }}
          restore-keys: |
            rag-index-
      
      - name: Index Documentation (if needed)
        run: |
          if [ ! -f "document_index.db" ] || [ ! -s "document_index.db" ]; then
            echo "üìö –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏..."
            ./gradlew runIndexDocs --quiet
          else
            echo "‚úÖ RAG –∏–Ω–¥–µ–∫—Å –Ω–∞–π–¥–µ–Ω –≤ –∫—ç—à–µ"
          fi
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      
      - name: Run AI Code Review
        id: ai-review
        run: |
          ./gradlew runCodeReview \
            --args="--pr=${{ github.event.pull_request.number }} \
                    --repo=${{ github.repository }} \
                    --base-sha=${{ github.event.pull_request.base.sha }} \
                    --head-sha=${{ github.event.pull_request.head.sha }} \
                    --output=review-output.json"
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Post Review Comment
        if: always() && steps.ai-review.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // –ß–∏—Ç–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç review
            let reviewData;
            try {
              reviewData = JSON.parse(fs.readFileSync('review-output.json', 'utf8'));
            } catch (e) {
              console.log('No review output found, skipping comment');
              return;
            }
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
            const verdictEmoji = {
              'approve': '‚úÖ',
              'request_changes': 'üî¥',
              'comment': 'üí¨'
            };
            
            let body = `## ü§ñ AI Code Review\n\n`;
            body += `**Verdict:** ${verdictEmoji[reviewData.verdict] || 'üí¨'} ${reviewData.verdict?.toUpperCase() || 'COMMENT'}\n\n`;
            body += `### Summary\n${reviewData.summary}\n\n`;
            
            if (reviewData.issues && reviewData.issues.length > 0) {
              body += `### Issues Found (${reviewData.issues.length})\n\n`;
              body += `| Severity | File | Description |\n`;
              body += `|----------|------|-------------|\n`;
              
              for (const issue of reviewData.issues) {
                const severityEmoji = {
                  'critical': 'üö®',
                  'security': 'üîí',
                  'performance': '‚ö°',
                  'logic': '‚ö†Ô∏è',
                  'style': '‚ú®'
                };
                const emoji = severityEmoji[issue.severity] || 'üìù';
                body += `| ${emoji} ${issue.severity} | \`${issue.file}:${issue.line}\` | ${issue.title} |\n`;
              }
              body += '\n';
              
              // –î–µ—Ç–∞–ª–∏ –∫–∞–∂–¥–æ–π –ø—Ä–æ–±–ª–µ–º—ã
              body += `<details>\n<summary>üìã Issue Details</summary>\n\n`;
              for (const issue of reviewData.issues) {
                body += `#### ${issue.title}\n`;
                body += `**File:** \`${issue.file}:${issue.line}\`\n\n`;
                body += `${issue.description}\n\n`;
                if (issue.suggestion) {
                  body += `**Suggestion:**\n\`\`\`\n${issue.suggestion}\n\`\`\`\n\n`;
                }
              }
              body += `</details>\n\n`;
            }
            
            if (reviewData.positive_notes && reviewData.positive_notes.length > 0) {
              body += `### ‚ú® Positive Notes\n`;
              for (const note of reviewData.positive_notes) {
                body += `- ${note}\n`;
              }
              body += '\n';
            }
            
            body += `---\n`;
            body += `<sub>Generated by AI Code Review Pipeline | Claude Opus 4.5</sub>`;
            
            // –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç –±–æ—Ç–∞
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('ü§ñ AI Code Review')
            );
            
            if (botComment) {
              // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
              console.log('Updated existing review comment');
            } else {
              // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
              console.log('Created new review comment');
            }
      
      - name: Upload Review Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai-review-pr-${{ github.event.pull_request.number }}
          path: review-output.json
          retention-days: 30
      
      - name: Set Review Status
        if: always() && steps.ai-review.outcome == 'success'
        run: |
          if [ -f "review-output.json" ]; then
            VERDICT=$(jq -r '.verdict // "comment"' review-output.json)
            CRITICAL_COUNT=$(jq '[.issues[]? | select(.severity == "critical" or .severity == "security")] | length' review-output.json)
            
            echo "Verdict: $VERDICT"
            echo "Critical issues: $CRITICAL_COUNT"
            
            if [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo "::warning::Found $CRITICAL_COUNT critical/security issues"
              # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: exit 1 –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ PR
            fi
          fi
