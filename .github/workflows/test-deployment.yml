name: Test Deployment

on:
  workflow_dispatch:
    inputs:
      deployment_url:
        description: 'Deployment URL to test'
        required: true
        default: 'http://localhost:8080'
  schedule:
    # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 2:00 UTC –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
    - cron: '0 2 * * *'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Test Health Endpoint
        run: |
          DEPLOYMENT_URL="${{ github.event.inputs.deployment_url || 'http://localhost:8080' }}"
          
          echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–ø–ª–æ—è –Ω–∞ $DEPLOYMENT_URL"
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ health endpoint
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ Health Check..."
          response=$(curl -s -w "\n%{http_code}" "${DEPLOYMENT_URL}/api/health" || echo -e "\n000")
          http_code=$(echo "$response" | tail -n1)
          
          if [ "$http_code" = "200" ]; then
            echo "‚úÖ Health Check: OK"
          else
            echo "‚ùå Health Check: FAILED (HTTP $http_code)"
            exit 1
          fi
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ deployment test endpoint
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ Deployment Test..."
          response=$(curl -s -w "\n%{http_code}" "${DEPLOYMENT_URL}/api/deployment/test" || echo -e "\n000")
          http_code=$(echo "$response" | tail -n1)
          
          if [ "$http_code" = "200" ]; then
            echo "‚úÖ Deployment Test: OK"
            echo "–û—Ç–≤–µ—Ç: $(echo "$response" | sed '$d')"
          else
            echo "‚ùå Deployment Test: FAILED (HTTP $http_code)"
            exit 1
          fi
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ version endpoint
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ Version Info..."
          response=$(curl -s -w "\n%{http_code}" "${DEPLOYMENT_URL}/api/version" || echo -e "\n000")
          http_code=$(echo "$response" | tail -n1)
          
          if [ "$http_code" = "200" ]; then
            echo "‚úÖ Version Info: OK"
            echo "–û—Ç–≤–µ—Ç: $(echo "$response" | sed '$d')"
          else
            echo "‚ùå Version Info: FAILED (HTTP $http_code)"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
          
        continue-on-error: true
