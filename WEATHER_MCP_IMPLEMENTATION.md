# Реализация MCP-инструмента для OpenWeather API

## Описание

Реализован MCP-инструмент для получения данных о погоде через OpenWeather API One Call API 3.0.

## Структура реализации

### 1. Клиент для OpenWeather API

**Файл:** `src/main/kotlin/org/example/weather/WeatherClient.kt`

Клиент для взаимодействия с OpenWeather API:
- Поддержка получения текущей погоды и прогноза
- Обработка ошибок API
- Поддержка единиц измерения (metric, imperial, standard)

**Файл:** `src/main/kotlin/org/example/weather/WeatherModels.kt`

Модели данных для работы с API:
- `WeatherResponse` - основной ответ API
- `CurrentWeather` - текущая погода
- `HourlyForecast` - почасовой прогноз
- `DailyForecast` - дневной прогноз
- `WeatherAlert` - погодные предупреждения

**Файл:** `src/main/kotlin/org/example/weather/WeatherError.kt`

Классы для обработки ошибок API.

### 2. MCP Сервер

**Файл:** `src/main/kotlin/org/example/mcp/server/WeatherMcpServer.kt`

MCP сервер, реализующий протокол JSON-RPC для работы с погодой:
- Обработка методов: `initialize`, `tools/list`, `tools/call`
- Инструмент `get_weather` для получения данных о погоде
- Валидация параметров (широта, долгота, единицы измерения)

### 3. Интеграция в приложение

**Обновлен:** `src/main/kotlin/org/example/Main.kt`

- Запуск WeatherMcpServer на порту 8082
- Подключение к обоим MCP серверам (Notion и Weather)
- Регистрация инструментов в ToolRegistry

**Обновлен:** `src/main/kotlin/org/example/config/AppConfig.kt`

- Добавлена поддержка API ключа погоды через переменную окружения `WEATHER_API_KEY` или файл `local.properties`
- По умолчанию используется ключ: `0858c22eadb4261a5e67533bd039a9de`

**Обновлен:** `src/main/kotlin/org/example/tools/McpToolAdapter.kt`

- Добавлено форматирование результатов погоды для читаемого вывода
- Отображение текущей погоды, прогноза на 8 дней и почасового прогноза

## Использование

### Запуск приложения

1. Убедитесь, что у вас настроен API ключ OpenRouter
2. Запустите приложение: `./gradlew run`
3. Приложение автоматически запустит оба MCP сервера:
   - Notion MCP Server на порту 8081
   - Weather MCP Server на порту 8082

### Использование инструмента

После запуска агент автоматически получит доступ к инструменту `get_weather`. Вы можете запросить погоду, например:

```
Какая погода в Москве? (координаты: 55.7558, 37.6173)
```

Или напрямую указать координаты:

```
Получи погоду для координат 55.7558, 37.6173
```

### Параметры инструмента

- `lat` (обязательный) - широта от -90 до 90
- `lon` (обязательный) - долгота от -180 до 180  
- `units` (опциональный) - единицы измерения:
  - `metric` (по умолчанию) - Цельсий, м/с
  - `imperial` - Фаренгейт, мили/ч
  - `standard` - Кельвин, м/с

## Пример ответа

Инструмент возвращает:
- Текущую погоду (температура, влажность, давление, ветер, облачность, UV индекс)
- Прогноз на 8 дней (температура мин/макс, описание погоды)
- Почасовой прогноз на 48 часов (первые 6 часов отображаются)

## Архитектура

```
┌─────────────────┐
│  OpenRouterAgent│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  ToolRegistry    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐      ┌──────────────────┐
│  McpToolAdapter  │◄─────│  McpClient       │
└─────────────────┘      └────────┬─────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │                           │
         ┌──────────▼──────┐        ┌───────────▼────────┐
         │ NotionMcpServer │        │ WeatherMcpServer   │
         │  (port 8081)    │        │  (port 8082)       │
         └─────────┬───────┘        └───────────┬────────┘
                   │                            │
         ┌─────────▼──────┐        ┌───────────▼────────┐
         │  NotionClient   │        │  WeatherClient     │
         └─────────────────┘        └───────────┬────────┘
                                                │
                                    ┌───────────▼────────┐
                                    │  OpenWeather API   │
                                    └────────────────────┘
```

## Технические детали

- Используется OpenWeather One Call API 3.0
- Протокол: JSON-RPC 2.0
- Формат данных: JSON
- HTTP клиент: Ktor CIO
- Сериализация: kotlinx.serialization

## Примечания

- API ключ по умолчанию предоставлен для тестирования
- Для production использования рекомендуется использовать свой API ключ
- OpenWeather One Call API 3.0 требует отдельной подписки "One Call by Call"
