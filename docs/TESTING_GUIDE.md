# Руководство по тестированию реализации

## Обзор

Это руководство поможет вам проверить работу всех реализованных функций:
- Stage 2: MCP stdio транспорт
- Stage 3: Android эмулятор агент

## Предварительные требования

### Базовые требования
- JDK 17+
- Gradle (включен в проект)
- API ключ OpenRouter

### Для Android эмулятора (опционально)
- Android SDK установлен
- Создан хотя бы один AVD (Android Virtual Device)
- Chrome установлен в эмуляторе

## Настройка

### 1. Настройка API ключа

Создайте файл `local.properties` в корне проекта:

```properties
OPENROUTER_API_KEY=sk-or-v1-ваш_ключ
```

Или установите переменную окружения:
```bash
# Windows
set OPENROUTER_API_KEY=sk-or-v1-ваш_ключ

# Linux/macOS
export OPENROUTER_API_KEY=sk-or-v1-ваш_ключ
```

### 2. Настройка Android SDK (для тестирования эмулятора)

Если вы хотите протестировать Android эмулятор функциональность, добавьте в `local.properties`:

```properties
   ANDROID_SDK_PATH=C:\Users\YourName\AppData\Local\Android\Sdk
```

Или через переменную окружения:
```bash
# Windows
set ANDROID_SDK_PATH=C:\Users\YourName\AppData\Local\Android\Sdk

# Linux/macOS
export ANDROID_SDK_PATH=/path/to/android/sdk
```

**Примечание**: Путь должен указывать на корневую директорию Android SDK, где находятся папки `platform-tools` и `emulator`.

### 3. Настройка транспорта MCP (опционально)

По умолчанию используется HTTP транспорт. Для использования stdio транспорта:

```properties
MCP_TRANSPORT=stdio
```

Или:
```bash
set MCP_TRANSPORT=stdio
```

## Тестирование

### Тест 1: Базовая функциональность

1. Запустите приложение:
```bash
# Windows
gradlew.bat run --console=plain

# Linux/macOS
./gradlew run --console=plain
```

2. Проверьте, что приложение запускается и показывает приветственное сообщение.

3. Попробуйте базовые команды:
   - `/help` - показать справку
   - "Который сейчас час?" - проверить работу инструментов
   - `/exit` - выход

### Тест 2: MCP stdio транспорт

**Важно**: stdio транспорт предназначен для использования в режиме, когда приложение запускается как дочерний процесс и общается через stdin/stdout.

Для тестирования stdio транспорта:

1. Установите транспорт:
```properties
MCP_TRANSPORT=stdio
```

2. Запустите приложение (stdio транспорт будет использовать System.in и System.out)

3. Проверьте, что MCP клиент может работать через stdio

**Примечание**: Полное тестирование stdio транспорта требует интеграции с MCP сервером, который также использует stdio.

### Тест 3: Android эмулятор агент

#### Подготовка

1. Убедитесь, что Android SDK установлен и путь настроен
2. Создайте AVD (Android Virtual Device):
   ```bash
   # Откройте Android Studio -> Tools -> Device Manager -> Create Device
   # Или используйте командную строку:
   emulator -list-avds
   ```

3. Установите Chrome в эмуляторе (обычно предустановлен)

#### Тестирование

1. Запустите приложение с настроенным Android SDK

2. Попробуйте запросы для поиска на устройстве:
   - "Найди на устройстве: Kotlin programming"
   - "Find on device: Android development"
   - "Поиск на эмуляторе: weather forecast"

3. Ожидаемое поведение:
   - Агент определяет намерение поиска на устройстве
   - Проверяет, запущен ли эмулятор
   - Если нет - запускает эмулятор (может занять 1-2 минуты)
   - Ждет полной загрузки системы
   - Открывает Chrome с поисковым запросом

#### Проверка логов

При запуске вы должны увидеть:
```
✅ Device search service initialized (Android emulator support enabled)
```

Если Android SDK не настроен, эта строка не появится, но приложение продолжит работать.

### Тест 4: Интеграция с существующими MCP серверами

1. Запустите приложение
2. Проверьте, что подключаются локальные MCP серверы:
   - Notion MCP Server (порт 8081)
   - Weather MCP Server (порт 8082)

3. Попробуйте использовать инструменты:
   - "Какая погода?" - должен использовать weather tool
   - "Получи страницу Notion [page_id]" - должен использовать notion tool

## Устранение неполадок

### Проблема: "API ключ не найден"
**Решение**: Убедитесь, что `OPENROUTER_API_KEY` установлен в `local.properties` или переменных окружения.

### Проблема: "Device search service не инициализирован"
**Решение**: 
- Проверьте, что `ANDROID_SDK_PATH` настроен правильно
- Убедитесь, что путь указывает на корневую директорию SDK
- Проверьте, что `adb` и `emulator` доступны по указанным путям

### Проблема: "Emulator не запускается"
**Решение**:
- Убедитесь, что хотя бы один AVD создан
- Проверьте, что эмулятор не запущен вручную (закройте его)
- Проверьте логи на наличие ошибок ADB

### Проблема: "Chrome не открывается"
**Решение**:
- Убедитесь, что Chrome установлен в эмуляторе
- Проверьте, что эмулятор полностью загрузился
- Попробуйте установить Chrome вручную через Play Store в эмуляторе

## Примеры тестовых сценариев

### Сценарий 1: Базовый поиск на устройстве
```
Пользователь: Найди на устройстве: Kotlin coroutines
Ожидаемый результат: Эмулятор запускается (если не запущен), Chrome открывается с поисковым запросом
```

### Сценарий 2: Поиск при уже запущенном эмуляторе
```
1. Запустите эмулятор вручную
2. Пользователь: Find on device: Android Studio
Ожидаемый результат: Chrome открывается сразу (без ожидания запуска эмулятора)
```

### Сценарий 3: Обычный запрос (не поиск на устройстве)
```
Пользователь: Какая погода?
Ожидаемый результат: Агент использует weather tool, не запускает эмулятор
```

## Проверка кода

Все файлы реализованы и должны компилироваться без ошибок:

```bash
# Проверка компиляции
gradlew.bat build

# Запуск с проверкой
gradlew.bat run --console=plain
```

## Дополнительная информация

- Документация по Stage 1: `docs/STAGE1_ANALYSIS.md`
- Документация по Stage 2: `docs/STAGE2_STDIO_TRANSPORT.md`
- Документация по Stage 3: `docs/STAGE3_ANDROID_AGENT.md`
- Валидация: `docs/STAGE4_VALIDATION.md`

